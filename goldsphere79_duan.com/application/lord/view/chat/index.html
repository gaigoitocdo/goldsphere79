{include file="head" /}
{include file="menu" /}
<style>
    .chat-layout {
        display: flex;
        height: 85vh;
        max-width: 95%;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
    }
    .chat-sidebar {
        width: 300px;
        border-right: 1px solid #ddd;
        padding: 15px;
        background: #f8f9fa;
        overflow-y: auto;
    }
    .chat-sidebar h3 {
        margin-top: 0;
        font-size: 18px;
        margin-bottom: 15px;
    }
    .conversation {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
        cursor: pointer;
        background: #e9ecef;
        position: relative;
    }
    .conversation.active {
        background: #007bff;
        color: white;
    }
    .conversation .delete-conv {
        display: none;
        position: absolute;
        right: 5px;
        top: 5px;
        color: red;
        cursor: pointer;
    }
    .conversation:hover .delete-conv {
        display: block;
    }
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        background: #007bff;
        color: white;
        padding: 15px;
        font-weight: bold;
        text-align: center;
    }
    .chat-box {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f1f1f1;
    }
    .message {
        margin: 10px 0;
        max-width: 70%;
        padding: 10px;
        border-radius: 10px;
        position: relative;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .message.sent {
        margin-left: auto;
        background: #007bff;
        color: #fff;
        text-align: right;
    }
    .message.received {
        margin-right: auto;
        background: #e2e3e5;
        text-align: left;
    }
    .message small {
        display: block;
        font-size: 10px;
        margin-top: 5px;
        opacity: 0.6;
        clear: both;
        width: auto;
    }
    .message .delete-msg {
        display: none;
        position: absolute;
        right: 5px;
        top: 5px;
        color: red;
        cursor: pointer;
    }
    .message:hover .delete-msg {
        display: block;
    }
    .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        background: white;
    }
    .chat-input textarea {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-right: 10px;
        resize: none;
        height: 40px;
        overflow-y: auto;
    }
    .chat-input input[type="file"] {
        display: none;
    }
    .chat-input .image-label {
        background: #cdcdcd;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
        margin-bottom: 0;
        font-size: 15px;
    }
    .chat-input button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
    }
    .chat-input button:hover {
        background: #0056b3;
    }
    .quick-commands-btn {
        background: #28a745;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }
    .modal-content {
        background: white;
        width: 500px;
        margin: 100px auto;
        padding: 20px;
        border-radius: 8px;
    }
    .modal-content h3 {
        margin-top: 0;
    }
    .command-row {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
    }
    .command-row input {
        flex: 1;
        margin-right: 10px;
        padding: 5px;
    }
    .command-row button {
        padding: 5px 10px;
    }
</style>
<section id="main-content">
<section class="wrapper">
<div class="row">
<div class="col-sm-12">
<div class="chat-layout">
    <div class="chat-sidebar">
        <h3>Danh s√°ch chat</h3>
        <div id="conversation-list">
            {foreach $conversations as $conv}
                <div class="conversation" data-id="{$conv.conversation_id}">
                    <strong>{$conv.username}</strong><br>
                    {if $conv.admin_unread_count > 0}
                        <small style="color: red;">{$conv.admin_unread_count} ch∆∞a ƒë·ªçc</small>
                    {/if}
                    <span class="delete-conv" onclick="deleteConversation({$conv.conversation_id})">‚úï</span>
                </div>
            {/foreach}
        </div>
    </div>
    <div class="chat-main">
        <div class="chat-header" id="chat-title">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</div>
        <div class="chat-box" id="chat-box"></div>
        <div class="chat-input">
            <div class="quick-commands-btn" onclick="openQuickCommands()">Quick Commands</div>
            <textarea id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn ho·∫∑c icon üòä" rows="1"></textarea>
            <label class="image-label" for="image-input">üì∑</label>
            <input type="file" id="image-input" accept="image/*">
            <button onclick="sendMessage()">G·ª≠i</button>
        </div>
    </div>
</div>
</div>
</div>
</section>
</section>

<!-- Quick Commands Modal -->
<div id="quickCommandsModal" class="modal">
    <div class="modal-content">
        <h3>Qu·∫£n l√Ω Quick Commands</h3>
        <div id="commandsList"></div>
        <div class="command-row">
            <input type="text" id="newCommand" placeholder="Command (e.g., /hello)">
            <input type="text" id="newContent" placeholder="N·ªôi dung tin nh·∫Øn">
            <button onclick="saveQuickCommand()">Th√™m</button>
        </div>
        <button onclick="closeQuickCommands()">ƒê√≥ng</button>
    </div>
</div>

<script>
    var currentConversationId = null;
    var lastMessageId = 0;
    var uid = 0;
    var quickCommands = [];

    // Utility function to escape content for safe HTML insertion
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleTimeString() + ' ' + date.toLocaleDateString();
    }


    function loadNewMessages() {
        if (!currentConversationId) return;
        $.post("{:url('lord/Chat/getNewMessages')}", {
            conversation_id: currentConversationId,
            last_message_id: lastMessageId
        }, function(res) {
            if (res.status == 1 && res.messages.length > 0) {
                res.messages.forEach(function(msg) {
                    const isSent = msg.sender_id == uid;
                    let content = msg.message_type === 'image'
                        ? '<img src="/public' + escapeHtml(msg.content) + '" style="max-width:100%;border-radius:6px;">'
                        : escapeHtml(msg.content); // Escape content for safe rendering
                    console.log('Rendering message content:', msg.content); // Debug log
                    $('#chat-box').append(
                        '<div class="message ' + (isSent ? 'sent' : 'received') + '" data-id="' + msg.message_id + '">' +
                        content +
                        '<small>' + formatTime(msg.sent_at) + '</small>' +
                        '<span class="delete-msg" onclick="deleteMessage(' + msg.message_id + ')">‚úï</span>' +
                        '</div>'
                    );
                    lastMessageId = Math.max(lastMessageId, msg.message_id);
                });
                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
            }
        });
    }

    function sendMessage() {
        const text = $('#message-input').val().trim();
        const image = $('#image-input')[0].files[0];
        const type = image ? 'image' : (text === 'üòä' ? 'icon' : (text ? 'text' : null));
        if (!type || !currentConversationId) {
            console.log('Cannot send: No content or conversation ID');
            return;
        }

        let content = (type === 'text' || type === 'icon') ? text : '';
        let formData = new FormData();
        formData.append('conversation_id', currentConversationId);
        formData.append('content', content);
        formData.append('type', type);
        if (type === 'image') {
            formData.append('image', image);
        }

        $.ajax({
            url: "{:url('lord/Chat/sendMessage')}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
                if (res.status == 1) {
                    $('#message-input').val('');
                    $('#image-input').val('');
                    loadNewMessages();
                } else {
                    alert(res.msg);
                }
            },
            error: function(xhr, status, error) {
                console.log('Send message failed:', status, error);
            }
        });
    }

    function checkQuickCommand(text) {
        console.log('Checking quick command:', text);
        console.log('Current quickCommands:', quickCommands);
        if (!text || typeof text !== 'string') {
            console.log('Invalid input text');
            return false;
        }
        if (text[0] === '/') {
            const command = quickCommands.find(cmd => cmd.command.toLowerCase() === text.toLowerCase());
            if (command) {
                console.log('Found command:', command);
                $('#message-input').val(command.content);
                return true;
            } else {
                console.log('No matching command found for:', text);
            }
        }
        return false;
    }

    function openQuickCommands() {
        $.get("{:url('lord/Chat/getQuickCommands')}", function(res) {
            if (res.status == 1) {
                quickCommands = res.commands || [];
                console.log('Loaded quickCommands:', quickCommands);
                const commandsList = $('#commandsList');
                commandsList.empty();
                res.commands.forEach(cmd => {
                    commandsList.append(
                        `<div class="command-row">
                            <input type="text" value="${escapeHtml(cmd.command)}" disabled>
                            <input type="text" value="${escapeHtml(cmd.content)}" disabled>
                            <button onclick="editQuickCommand(${cmd.id}, '${escapeHtml(cmd.command)}', '${escapeHtml(cmd.content)}')">S·ª≠a</button>
                            <button onclick="deleteQuickCommand(${cmd.id})">X√≥a</button>
                        </div>`
                    );
                });
                $('#quickCommandsModal').show();
            } else {
                console.log('Failed to load quick commands:', res.msg);
            }
        });
    }

    function closeQuickCommands() {
        $('#quickCommandsModal').hide();
        $('#newCommand').val('');
        $('#newContent').val('');
    }

    function saveQuickCommand(id = null) {
        const command = $('#newCommand').val().trim();
        const content = $('#newContent').val().trim();
        $.post("{:url('lord/Chat/saveQuickCommand')}", {
            id: id,
            command: command,
            content: content
        }, function(res) {
            if (res.status == 1) {
                openQuickCommands();
                $('#newCommand').val('');
                $('#newContent').val('');
            } else {
                alert(res.msg);
            }
        });
    }

    function editQuickCommand(id, command, content) {
        $('#newCommand').val(command);
        $('#newContent').val(content);
        $('#newCommand').data('edit-id', id);
    }

    function deleteQuickCommand(id) {
        if (confirm('X√°c nh·∫≠n x√≥a quick command?')) {
            $.post("{:url('lord/Chat/deleteQuickCommand')}", { id: id }, function(res) {
                if (res.status == 1) {
                    openQuickCommands();
                } else {
                    alert(res.msg);
                }
            });
        }
    }

    function deleteMessage(message_id) {
        if (confirm('X√°c nh·∫≠n x√≥a tin nh·∫Øn?')) {
            $.post("{:url('lord/Chat/deleteMessage')}", { message_id: message_id }, function(res) {
                if (res.status == 1) {
                    $(`.message[data-id="${message_id}"]`).remove();
                } else {
                    alert(res.msg);
                }
            });
        }
    }

    function deleteConversation(conversation_id) {
        if (confirm('X√°c nh·∫≠n x√≥a to√†n b·ªô cu·ªôc tr√≤ chuy·ªán?')) {
            $.post("{:url('lord/Chat/deleteConversation')}", { conversation_id: conversation_id }, function(res) {
                if (res.status == 1) {
                    $(`.conversation[data-id="${conversation_id}"]`).remove();
                    if (currentConversationId == conversation_id) {
                        currentConversationId = null;
                        $('#chat-box').empty();
                        $('#chat-title').text('Ch·ªçn cu·ªôc tr√≤ chuy·ªán');
                    }
                } else {
                    alert(res.msg);
                }
            });
        }
    }

    $('#image-input').on('change', function () {
        if (this.files.length > 0) sendMessage();
    });

    $(document).ready(function() {
        setInterval(loadNewMessages, 2000);

        $('.conversation').on('click', function() {
            $('.conversation').removeClass('active');
            $(this).addClass('active');
            currentConversationId = $(this).data('id');
            $('#chat-title').text('ƒêang chat v·ªõi #' + currentConversationId);
            $('#chat-box').empty();
            lastMessageId = 0;
            loadNewMessages();
        });

        $('#message-input').on('keydown', function(e) {
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                const text = $(this).val().trim();
                console.log('Shift+Enter pressed, text:', text);
                if (checkQuickCommand(text)) {
                    console.log('Quick command expanded, waiting for next Shift+Enter');
                    return;
                }
                sendMessage();
            }
        });

        // Preload quick commands on page load
        $.get("{:url('lord/Chat/getQuickCommands')}", function(res) {
            if (res.status == 1) {
                quickCommands = res.commands || [];
                console.log('Initial quickCommands load:', quickCommands);
            } else {
                console.log('Failed to load quick commands:', res.msg);
            }
        });
    });

        $('#message-input').on('keypress', function(e) {
            if (e.which == 13) {
                const text = $(this).val().trim();
                if (checkQuickCommand(text)) {
                    return;
                }
                //sendMessage();
            }
        });
</script>
{include file="foot" /}